source /usr/share/zsh/config/zshrc
export PROMPT='$CYAN%n@$YELLOW$(hostname):$FG[039]$GREEN$(_fish_collapsed_pwd)%f > '
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/.local/clangd/clangd_19.1.2/bin:$PATH"

# =============================================================================
# ä»£ç†å¼€å¯å…³é—­å¿«æ·å‘½ä»¤
# =============================================================================

# ä»£ç†æœåŠ¡å™¨é…ç½® (æ ¹æ®ä½ çš„å®é™…ä»£ç†æœåŠ¡å™¨ä¿®æ”¹)
PROXY_HOST="10.0.11.100"
PROXY_PORT="7890"
PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"

# å¼€å¯ä»£ç†
function proxy_on() {
    export http_proxy="${PROXY_URL}"
    export https_proxy="${PROXY_URL}"
    export HTTP_PROXY="${PROXY_URL}"
    export HTTPS_PROXY="${PROXY_URL}"
    export ftp_proxy="${PROXY_URL}"
    export FTP_PROXY="${PROXY_URL}"
    export all_proxy="${PROXY_URL}"
    export ALL_PROXY="${PROXY_URL}"
    
    # è®¾ç½®ä¸èµ°ä»£ç†çš„åœ°å€ (æœ¬åœ°åœ°å€å’Œå†…ç½‘åœ°å€)
    export no_proxy="localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,::1"
    export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,::1"
    
    echo "ğŸŒ ä»£ç†å·²å¼€å¯"
    echo "   HTTP Proxy:  ${http_proxy}"
    echo "   HTTPS Proxy: ${https_proxy}"
    echo "   No Proxy:    ${no_proxy}"
}

# å…³é—­ä»£ç†
function proxy_off() {
    unset http_proxy
    unset https_proxy
    unset HTTP_PROXY
    unset HTTPS_PROXY
    unset ftp_proxy
    unset FTP_PROXY
    unset all_proxy
    unset ALL_PROXY
    unset no_proxy
    unset NO_PROXY
    
    echo "ğŸš« ä»£ç†å·²å…³é—­"
}

# æŸ¥çœ‹ä»£ç†çŠ¶æ€
function proxy_status() {
    echo "ğŸ“¡ ä»£ç†çŠ¶æ€ï¼š"
    if [ -n "$http_proxy" ]; then
        echo "   âœ… ä»£ç†å·²å¼€å¯"
        echo "   HTTP:  ${http_proxy:-æœªè®¾ç½®}"
        echo "   HTTPS: ${https_proxy:-æœªè®¾ç½®}"
        echo "   No Proxy: ${no_proxy:-æœªè®¾ç½®}"
    else
        echo "   âŒ ä»£ç†å·²å…³é—­"
    fi
}

# æµ‹è¯•ä»£ç†è¿æ¥
function proxy_test() {
    if [ -n "$http_proxy" ]; then
        echo "ğŸ” æµ‹è¯•ä»£ç†è¿æ¥..."
        echo "å½“å‰ä»£ç†: ${http_proxy}"
        
        # æµ‹è¯•ä»£ç†æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
        if curl -s --connect-timeout 5 --proxy "${http_proxy}" "http://www.google.com" > /dev/null; then
            echo "âœ… ä»£ç†è¿æ¥æ­£å¸¸"
        else
            echo "âŒ ä»£ç†è¿æ¥å¤±è´¥"
        fi
        
        # æ˜¾ç¤ºå½“å‰ IP
        echo "ğŸŒ å½“å‰å¤–ç½‘ IP:"
        curl -s --connect-timeout 10 --proxy "${http_proxy}" "https://ipinfo.io/ip" || echo "è·å– IP å¤±è´¥"
    else
        echo "âŒ ä»£ç†æœªå¼€å¯ï¼Œè¯·å…ˆè¿è¡Œ proxy_on"
    fi
}

# Git ä»£ç†è®¾ç½®
function git_proxy_on() {
    git config --global http.proxy "${PROXY_URL}"
    git config --global https.proxy "${PROXY_URL}"
    echo "âœ… Git ä»£ç†å·²å¼€å¯: ${PROXY_URL}"
}

function git_proxy_off() {
    git config --global --unset http.proxy
    git config --global --unset https.proxy
    echo "âœ… Git ä»£ç†å·²å…³é—­"
}

function git_proxy_status() {
    echo "ğŸ“¡ Git ä»£ç†çŠ¶æ€ï¼š"
    local git_http_proxy=$(git config --global --get http.proxy)
    local git_https_proxy=$(git config --global --get https.proxy)
    
    if [ -n "$git_http_proxy" ] || [ -n "$git_https_proxy" ]; then
        echo "   âœ… Git ä»£ç†å·²å¼€å¯"
        echo "   HTTP:  ${git_http_proxy:-æœªè®¾ç½®}"
        echo "   HTTPS: ${git_https_proxy:-æœªè®¾ç½®}"
    else
        echo "   âŒ Git ä»£ç†å·²å…³é—­"
    fi
}

# å¿«æ·åˆ«å
alias pon='proxy_on'           # å¼€å¯ä»£ç†
alias poff='proxy_off'         # å…³é—­ä»£ç†
alias pst='proxy_status'       # æŸ¥çœ‹ä»£ç†çŠ¶æ€
alias ptest='proxy_test'       # æµ‹è¯•ä»£ç†
alias gpon='git_proxy_on'      # å¼€å¯ Git ä»£ç†
alias gpoff='git_proxy_off'    # å…³é—­ Git ä»£ç†
alias gpst='git_proxy_status'  # æŸ¥çœ‹ Git ä»£ç†çŠ¶æ€

# è‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºä»£ç†çŠ¶æ€
function check_proxy_on_startup() {
    if [ -n "$http_proxy" ]; then
        echo "ğŸŒ æ£€æµ‹åˆ°ä»£ç†å·²å¼€å¯: ${http_proxy}"
    fi
}

# å¯åŠ¨æ—¶æ£€æŸ¥ä»£ç†çŠ¶æ€
check_proxy_on_startup

# =============================================================================
# å¸¸ç”¨å¿«æ·å‘½ä»¤
# =============================================================================

# æ–‡ä»¶å’Œç›®å½•æ“ä½œ
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias ~='cd ~'
alias -- -='cd -'

# æ–‡ä»¶æŸ¥çœ‹å’Œç¼–è¾‘
alias cat='cat -n'          # æ˜¾ç¤ºè¡Œå·
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# ç³»ç»Ÿä¿¡æ¯
alias df='df -h'             # äººæ€§åŒ–æ˜¾ç¤ºç£ç›˜ä½¿ç”¨
alias du='du -h'             # äººæ€§åŒ–æ˜¾ç¤ºç›®å½•å¤§å°
alias free='free -h'         # äººæ€§åŒ–æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
alias ps='ps auxf'           # è¯¦ç»†è¿›ç¨‹ä¿¡æ¯
alias top='htop'             # å¦‚æœæœ‰ htop å°±ç”¨ htop

# ç½‘ç»œå·¥å…·
alias ping='ping -c 5'       # é»˜è®¤ ping 5 æ¬¡
alias wget='wget -c'         # æ”¯æŒæ–­ç‚¹ç»­ä¼ 

# å®‰å…¨æ“ä½œ
alias rm='rm -i'             # åˆ é™¤å‰ç¡®è®¤

# å¿«é€ŸæŸ¥æ‰¾
alias f='find . -name'       # å¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶
alias h='history | grep'     # åœ¨å†å²è®°å½•ä¸­æœç´¢

# è¿›ç¨‹ç®¡ç†
alias killall='pkill -f'     # æ ¹æ®åç§°æ€æ­»è¿›ç¨‹
alias ports='netstat -tulanp' # æŸ¥çœ‹ç«¯å£å ç”¨

# =============================================================================
# Git ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢
# =============================================================================

# Git ç”¨æˆ·é…ç½®é¢„è®¾
GIT_USER_WORK_NAME="zhaow"
GIT_USER_WORK_EMAIL="zhaow@zhcomputing.com"

GIT_USER_PERSONAL_NAME="zhaowei2025"
GIT_USER_PERSONAL_EMAIL="zhaowei2025@protonmail.com"

# åˆ‡æ¢åˆ°å·¥ä½œè´¦æˆ·
function git_work() {
    git config --global user.name "${GIT_USER_WORK_NAME}"
    git config --global user.email "${GIT_USER_WORK_EMAIL}"
    echo "ğŸ¢ å·²åˆ‡æ¢åˆ°å·¥ä½œ Git è´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_WORK_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_WORK_EMAIL}"
}

# åˆ‡æ¢åˆ°ä¸ªäººè´¦æˆ·
function git_personal() {
    git config --global user.name "${GIT_USER_PERSONAL_NAME}"
    git config --global user.email "${GIT_USER_PERSONAL_EMAIL}"
    echo "ğŸ‘¤ å·²åˆ‡æ¢åˆ°ä¸ªäºº Git è´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_PERSONAL_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_PERSONAL_EMAIL}"
}

# æŸ¥çœ‹å½“å‰ Git ç”¨æˆ·
function git_whoami() {
    local current_name=$(git config --global user.name)
    local current_email=$(git config --global user.email)
    
    echo "ğŸ“‹ å½“å‰ Git ç”¨æˆ·ä¿¡æ¯ï¼š"
    echo "   å§“å: ${current_name:-æœªè®¾ç½®}"
    echo "   é‚®ç®±: ${current_email:-æœªè®¾ç½®}"
    
    # åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªè´¦æˆ·
    if [[ "$current_name" == "$GIT_USER_WORK_NAME" && "$current_email" == "$GIT_USER_WORK_EMAIL" ]]; then
        echo "   ç±»å‹: ğŸ¢ å·¥ä½œè´¦æˆ·"
    elif [[ "$current_name" == "$GIT_USER_PERSONAL_NAME" && "$current_email" == "$GIT_USER_PERSONAL_EMAIL" ]]; then
        echo "   ç±»å‹: ğŸ‘¤ ä¸ªäººè´¦æˆ·"
    else
        echo "   ç±»å‹: â“ å…¶ä»–è´¦æˆ·"
    fi
}

# ä¸ºå½“å‰ä»“åº“è®¾ç½®ç‰¹å®šçš„ Git ç”¨æˆ·ï¼ˆä¸å½±å“å…¨å±€é…ç½®ï¼‰
function git_local_work() {
    git config user.name "${GIT_USER_WORK_NAME}"
    git config user.email "${GIT_USER_WORK_EMAIL}"
    echo "ğŸ¢ å·²ä¸ºå½“å‰ä»“åº“è®¾ç½®å·¥ä½œè´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_WORK_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_WORK_EMAIL}"
}

function git_local_personal() {
    git config user.name "${GIT_USER_PERSONAL_NAME}"
    git config user.email "${GIT_USER_PERSONAL_EMAIL}"
    echo "ğŸ‘¤ å·²ä¸ºå½“å‰ä»“åº“è®¾ç½®ä¸ªäººè´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_PERSONAL_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_PERSONAL_EMAIL}"
}

# æŸ¥çœ‹å½“å‰ä»“åº“çš„ Git é…ç½®
function git_local_whoami() {
    if [[ -d .git ]]; then
        local local_name=$(git config user.name)
        local local_email=$(git config user.email)
        local global_name=$(git config --global user.name)
        local global_email=$(git config --global user.email)
        
        echo "ğŸ“‹ å½“å‰ä»“åº“ Git é…ç½®ï¼š"
        echo "   æœ¬åœ°å§“å: ${local_name:-ä½¿ç”¨å…¨å±€é…ç½®}"
        echo "   æœ¬åœ°é‚®ç®±: ${local_email:-ä½¿ç”¨å…¨å±€é…ç½®}"
        echo "   å…¨å±€å§“å: ${global_name:-æœªè®¾ç½®}"
        echo "   å…¨å±€é‚®ç®±: ${global_email:-æœªè®¾ç½®}"
        
        # å®é™…ç”Ÿæ•ˆçš„é…ç½®
        local effective_name="${local_name:-$global_name}"
        local effective_email="${local_email:-$global_email}"
        echo "   ç”Ÿæ•ˆé…ç½®: ${effective_name} <${effective_email}>"
    else
        echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
    fi
}

# å¿«æ·åˆ«å
alias gwork='git_work'              # åˆ‡æ¢åˆ°å·¥ä½œè´¦æˆ·
alias gpersonal='git_personal'      # åˆ‡æ¢åˆ°ä¸ªäººè´¦æˆ·
alias gwho='git_whoami'             # æŸ¥çœ‹å½“å‰ç”¨æˆ·
alias glwork='git_local_work'       # å½“å‰ä»“åº“ä½¿ç”¨å·¥ä½œè´¦æˆ·
alias glpersonal='git_local_personal' # å½“å‰ä»“åº“ä½¿ç”¨ä¸ªäººè´¦æˆ·
alias glwho='git_local_whoami'      # æŸ¥çœ‹å½“å‰ä»“åº“é…ç½®

# =============================================================================
# Chezmoi GitHub åŒæ­¥å¿«æ·å‘½ä»¤
# =============================================================================

# åŒæ­¥é…ç½®åˆ° GitHub
function dotfiles_push() {
    echo "ğŸ“¤ åŒæ­¥ dotfiles åˆ° GitHub..."
    
    # ç¡®ä¿ä½¿ç”¨ä¸ªäººè´¦æˆ·
    gpersonal
    
    # æ·»åŠ æ‰€æœ‰æ›´æ”¹
    chezmoi git -- add .
    
    # æäº¤æ›´æ”¹
    local commit_msg="${1:-æ›´æ–° dotfiles é…ç½®}"
    chezmoi git -- commit -m "$commit_msg"
    
    # æ¨é€åˆ° GitHub
    chezmoi git -- push origin main || chezmoi git -- push --set-upstream origin main
    
    echo "âœ… dotfiles åŒæ­¥å®Œæˆï¼"
}

# ä» GitHub æ‹‰å–é…ç½®
function dotfiles_pull() {
    echo "ğŸ“¥ ä» GitHub æ‹‰å– dotfiles..."
    
    # ç¡®ä¿ä½¿ç”¨ä¸ªäººè´¦æˆ·
    gpersonal
    
    # æ‹‰å–æœ€æ–°æ›´æ”¹
    chezmoi git -- pull origin main
    
    # åº”ç”¨æ›´æ”¹
    chezmoi apply
    
    echo "âœ… dotfiles æ‹‰å–å®Œæˆï¼"
}

# æŸ¥çœ‹ dotfiles çŠ¶æ€
function dotfiles_status() {
    echo "ğŸ“Š Dotfiles çŠ¶æ€ï¼š"
    echo ""
    
    # æ˜¾ç¤ºå½“å‰ Git ç”¨æˆ·
    gwho
    echo ""
    
    # æ˜¾ç¤º chezmoi çŠ¶æ€
    echo "ğŸ“‹ Chezmoi çŠ¶æ€ï¼š"
    chezmoi status
    echo ""
    
    # æ˜¾ç¤º Git ä»“åº“çŠ¶æ€
    echo "ğŸ“‹ Git ä»“åº“çŠ¶æ€ï¼š"
    chezmoi cd && git status && cd -
}

# åˆå§‹åŒ–æ–°æœºå™¨çš„ dotfiles
function dotfiles_init() {
    echo "ğŸš€ åˆå§‹åŒ– dotfiles åˆ°æ–°æœºå™¨..."
    
    # å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå…ˆåˆ é™¤
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "âš ï¸  æ£€æµ‹åˆ°å·²å­˜åœ¨çš„ chezmoi é…ç½®ï¼Œæ­£åœ¨å¤‡ä»½..."
        mv "$HOME/.local/share/chezmoi" "$HOME/.local/share/chezmoi.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # å…‹éš†å¹¶åˆå§‹åŒ–
    chezmoi init https://github.com/zhaowei2025/dotfile.git
    
    # åº”ç”¨é…ç½®
    chezmoi apply
    
    echo "âœ… dotfiles åˆå§‹åŒ–å®Œæˆï¼"
}

# å¿«æ·åˆ«å
alias dfpush='dotfiles_push'        # æ¨é€é…ç½®
alias dfpull='dotfiles_pull'        # æ‹‰å–é…ç½®
alias dfstatus='dotfiles_status'    # æŸ¥çœ‹çŠ¶æ€
alias dfinit='dotfiles_init'        # åˆå§‹åŒ–æ–°æœºå™¨

echo "ğŸ‰ ä»£ç†ç®¡ç†å‘½ä»¤å·²åŠ è½½ï¼"
echo "ğŸ’¡ å¿«æ·å‘½ä»¤ï¼š"
echo "   pon/proxy_on     - å¼€å¯ä»£ç†"
echo "   poff/proxy_off   - å…³é—­ä»£ç†"
echo "   pst/proxy_status - æŸ¥çœ‹ä»£ç†çŠ¶æ€"
echo "   ptest/proxy_test - æµ‹è¯•ä»£ç†è¿æ¥"
echo "   gpon/git_proxy_on    - å¼€å¯ Git ä»£ç†"
echo "   gpoff/git_proxy_off  - å…³é—­ Git ä»£ç†"
echo "   gpst/git_proxy_status - æŸ¥çœ‹ Git ä»£ç†çŠ¶æ€"
echo "ğŸ“ å¸¸ç”¨å¿«æ·å‘½ä»¤å·²åŠ è½½: ll, .., f, h, ports ç­‰"
echo "ğŸ‘¥ Git ç”¨æˆ·åˆ‡æ¢å‘½ä»¤: gwork, gpersonal, gwho, glwork, glpersonal, glwho"
echo "ğŸ“¦ Dotfiles åŒæ­¥å‘½ä»¤: dfpush, dfpull, dfstatus, dfinit"
