# =============================================================================
# ZSH ç°ä»£åŒ–é…ç½®å¢å¼º
# =============================================================================

# Oh My Zsh é…ç½®
export ZSH="$HOME/.oh-my-zsh"

# ä¸»é¢˜è®¾ç½® (å¯é€‰æ‹©: agnoster, powerlevel10k, robbyrussell, af-magic, bira)
ZSH_THEME="agnoster"

# æ’ä»¶é…ç½®
plugins=(
    git                    # Git å¿«æ·å‘½ä»¤å’ŒçŠ¶æ€æ˜¾ç¤º
    zsh-autosuggestions   # è‡ªåŠ¨å»ºè®®å†å²å‘½ä»¤
    zsh-syntax-highlighting # è¯­æ³•é«˜äº®
    colored-man-pages     # å½©è‰² man é¡µé¢
    command-not-found     # å‘½ä»¤æœªæ‰¾åˆ°æ—¶å»ºè®®åŒ…å
    extract               # æ™ºèƒ½è§£å‹ç¼©
    z                     # æ™ºèƒ½ç›®å½•è·³è½¬
    sudo                  # åŒå‡» ESC æ·»åŠ  sudo
    web-search            # å¿«é€Ÿç½‘ç»œæœç´¢
    copypath              # å¤åˆ¶å½“å‰è·¯å¾„
    copybuffer            # å¤åˆ¶å½“å‰å‘½ä»¤è¡Œ
    dirhistory            # ç›®å½•å†å²å¯¼èˆª
    jsontools             # JSON å·¥å…·
    urltools              # URL å·¥å…·
    encode64              # Base64 ç¼–ç è§£ç 
)

# å¦‚æœ Oh My Zsh å­˜åœ¨åˆ™åŠ è½½
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    source "$ZSH/oh-my-zsh.sh"
else
    # å¦‚æœæ²¡æœ‰ Oh My Zshï¼Œä½¿ç”¨åŸæœ‰é…ç½®
    source /usr/share/zsh/config/zshrc
    export PROMPT='%F{cyan}%n@%F{yellow}%m:%F{green}%~%f > '
fi

# =============================================================================
# ZSH é€‰é¡¹é…ç½®
# =============================================================================

# å†å²è®°å½•é…ç½®
HISTSIZE=10000
SAVEHIST=10000
HISTFILE=~/.zsh_history

# å¯ç”¨æœ‰ç”¨çš„ zsh é€‰é¡¹
setopt HIST_EXPIRE_DUPS_FIRST    # é¦–å…ˆåˆ é™¤é‡å¤çš„å†å²æ¡ç›®
setopt HIST_IGNORE_DUPS          # ä¸ä¿å­˜é‡å¤çš„å†å²æ¡ç›®
setopt HIST_IGNORE_ALL_DUPS      # åˆ é™¤æ‰€æœ‰æ—§çš„é‡å¤æ¡ç›®
setopt HIST_FIND_NO_DUPS         # æœç´¢æ—¶ä¸æ˜¾ç¤ºé‡å¤æ¡ç›®
setopt HIST_IGNORE_SPACE         # ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤ä¸ä¿å­˜åˆ°å†å²
setopt HIST_SAVE_NO_DUPS         # ä¿å­˜æ—¶ä¸ä¿å­˜é‡å¤æ¡ç›®
setopt HIST_VERIFY               # å†å²å±•å¼€åç­‰å¾…ç”¨æˆ·ç¡®è®¤
setopt SHARE_HISTORY             # å¤šä¸ªç»ˆç«¯é—´å…±äº«å†å²
setopt APPEND_HISTORY            # è¿½åŠ å†å²è€Œä¸æ˜¯è¦†ç›–
setopt INC_APPEND_HISTORY        # ç«‹å³è¿½åŠ å†å²
setopt AUTO_CD                   # è¾“å…¥ç›®å½•åè‡ªåŠ¨ cd
setopt CORRECT                   # å‘½ä»¤çº é”™
setopt COMPLETE_IN_WORD          # åœ¨å•è¯ä¸­é—´ä¹Ÿèƒ½è¡¥å…¨
setopt ALWAYS_TO_END             # è¡¥å…¨åå…‰æ ‡ç§»åˆ°æœ«å°¾

# å¤§å°å†™ä¸æ•æ„Ÿçš„è¡¥å…¨
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'

# å½©è‰²è¡¥å…¨
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}

# =============================================================================
# é”®ç»‘å®šå¢å¼º
# =============================================================================

# ä½¿ç”¨ Emacs é”®ç»‘å®š
bindkey -e

# å†å²æœç´¢
bindkey '^R' history-incremental-search-backward
bindkey '^S' history-incremental-search-forward

# å¿«é€Ÿç¼–è¾‘å‘½ä»¤è¡Œ
autoload -U edit-command-line
zle -N edit-command-line
bindkey '^X^E' edit-command-line

# è¯æ±‡å¯¼èˆª
bindkey '^[[1;5C' forward-word   # Ctrl+Right
bindkey '^[[1;5D' backward-word  # Ctrl+Left

# =============================================================================
# ç°ä»£åŒ–å·¥å…·åˆ«å
# =============================================================================

# å¦‚æœå­˜åœ¨æ›´å¥½çš„å·¥å…·ï¼Œä½¿ç”¨å®ƒä»¬
if command -v exa >/dev/null 2>&1; then
    alias ls='exa --icons'
    alias ll='exa -alF --icons --git'
    alias la='exa -a --icons'
    alias lt='exa --tree --icons'
fi

if command -v bat >/dev/null 2>&1; then
    alias cat='bat --paging=never'
    alias bcat='bat'
fi

if command -v fd >/dev/null 2>&1; then
    alias find='fd'
fi

if command -v rg >/dev/null 2>&1; then
    alias grep='rg'
fi

if command -v lazygit >/dev/null 2>&1; then
    alias lg='lazygit'
fi

if command -v btm >/dev/null 2>&1; then
    alias top='btm'
    alias htop='btm'
fi

if command -v dust >/dev/null 2>&1; then
    alias du='dust'
fi

# =============================================================================
# å¢å¼ºåŠŸèƒ½å‡½æ•°
# =============================================================================

# æ™ºèƒ½ mkdir å¹¶è¿›å…¥ç›®å½•
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# å¿«é€ŸæŸ¥æ‰¾å¹¶ç¼–è¾‘æ–‡ä»¶
fvim() {
    local file
    file=$(fzf --preview 'bat --color=always --style=numbers --line-range=:500 {}' 2>/dev/null) && $EDITOR "$file"
}

# å¿«é€Ÿè¿›å…¥ç›®å½•
fcd() {
    local dir
    dir=$(find . -type d 2>/dev/null | fzf +m) && cd "$dir"
}

# æ™ºèƒ½è§£å‹ç¼©
extract() {
    if [ -f $1 ] ; then
        case $1 in
            *.tar.bz2)   tar xjf $1     ;;
            *.tar.gz)    tar xzf $1     ;;
            *.bz2)       bunzip2 $1     ;;
            *.rar)       unrar e $1     ;;
            *.gz)        gunzip $1      ;;
            *.tar)       tar xf $1      ;;
            *.tbz2)      tar xjf $1     ;;
            *.tgz)       tar xzf $1     ;;
            *.zip)       unzip $1       ;;
            *.Z)         uncompress $1  ;;
            *.7z)        7z x $1        ;;
            *)     echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# åˆ›å»ºå¤‡ä»½
backup() {
    cp "$1"{,.backup-$(date +%Y%m%d_%H%M%S)}
}

# å¿«é€Ÿå¯åŠ¨HTTPæœåŠ¡å™¨
serve() {
    local port="${1:-8000}"
    echo "ğŸŒ Starting HTTP server on port $port"
    echo "ğŸ“‚ Serving: $(pwd)"
    echo "ğŸ”— URL: http://localhost:$port"
    
    if command -v python3 >/dev/null 2>&1; then
        python3 -m http.server "$port"
    elif command -v python >/dev/null 2>&1; then
        python -m SimpleHTTPServer "$port"
    else
        echo "âŒ Python not found"
    fi
}

# ç³»ç»Ÿä¿¡æ¯æ˜¾ç¤º
sysinfo() {
    echo "ğŸ–¥ï¸  System Information"
    echo "===================="
    echo "ğŸ§ OS: $(uname -s) $(uname -r)"
    echo "ğŸ’» Architecture: $(uname -m)"
    echo "ğŸ‘¤ User: $(whoami)"
    echo "ğŸ  Home: $HOME"
    echo "â° Uptime: $(uptime -p 2>/dev/null || uptime)"
    echo "ğŸ’¾ Memory: $(free -h | awk '/^Mem:/ {printf "%s/%s (%.1f%%)", $3, $2, $3/$2*100}')"
    echo "ğŸ’¿ Disk: $(df -h / | awk 'NR==2 {printf "%s/%s (%s)", $3, $2, $5}')"
    echo "ğŸŒ¡ï¸  Load: $(uptime | awk '{print $NF}')"
}

# =============================================================================
# ç¯å¢ƒå˜é‡å¢å¼º
# =============================================================================

# è®¾ç½®ç¼–è¾‘å™¨
if command -v nvim >/dev/null 2>&1; then
    export EDITOR='nvim'
    export VISUAL='nvim'
elif command -v vim >/dev/null 2>&1; then
    export EDITOR='vim'
    export VISUAL='vim'
else
    export EDITOR='nano'
    export VISUAL='nano'
fi

# FZF é…ç½® (å¦‚æœå®‰è£…äº† fzf)
if command -v fzf >/dev/null 2>&1; then
    export FZF_DEFAULT_OPTS='
        --height 40% 
        --layout=reverse 
        --border 
        --preview="bat --color=always --style=numbers --line-range=:500 {}" 
        --preview-window=right:50%:wrap
    '
    
    if command -v fd >/dev/null 2>&1; then
        export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
        export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    fi
fi

# =============================================================================
# åŸæœ‰é…ç½®ä¿æŒä¸å˜ - PATHè®¾ç½®
# =============================================================================

# PATH è®¾ç½®
export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/.local/clangd/clangd_19.1.2/bin:$PATH"

# =============================================================================
# ä»£ç†å¼€å¯å…³é—­å¿«æ·å‘½ä»¤
# =============================================================================

# ä»£ç†æœåŠ¡å™¨é…ç½® (æ ¹æ®ä½ çš„å®é™…ä»£ç†æœåŠ¡å™¨ä¿®æ”¹)
PROXY_HOST="10.0.11.100"
PROXY_PORT="7890"
PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"

# å¼€å¯ä»£ç†
function proxy_on() {
    export http_proxy="${PROXY_URL}"
    export https_proxy="${PROXY_URL}"
    export HTTP_PROXY="${PROXY_URL}"
    export HTTPS_PROXY="${PROXY_URL}"
    export ftp_proxy="${PROXY_URL}"
    export FTP_PROXY="${PROXY_URL}"
    export all_proxy="${PROXY_URL}"
    export ALL_PROXY="${PROXY_URL}"
    
    # è®¾ç½®ä¸èµ°ä»£ç†çš„åœ°å€ (æœ¬åœ°åœ°å€å’Œå†…ç½‘åœ°å€)
    export no_proxy="localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,::1"
    export NO_PROXY="localhost,127.0.0.1,10.0.0.0/8,192.168.0.0/16,172.16.0.0/12,::1"
    
    echo "ğŸŒ ä»£ç†å·²å¼€å¯"
    echo "   HTTP Proxy:  ${http_proxy}"
    echo "   HTTPS Proxy: ${https_proxy}"
    echo "   No Proxy:    ${no_proxy}"
}

# å…³é—­ä»£ç†
function proxy_off() {
    unset http_proxy
    unset https_proxy
    unset HTTP_PROXY
    unset HTTPS_PROXY
    unset ftp_proxy
    unset FTP_PROXY
    unset all_proxy
    unset ALL_PROXY
    unset no_proxy
    unset NO_PROXY
    
    echo "ğŸš« ä»£ç†å·²å…³é—­"
}

# æŸ¥çœ‹ä»£ç†çŠ¶æ€
function proxy_status() {
    echo "ğŸ“¡ ä»£ç†çŠ¶æ€ï¼š"
    if [ -n "$http_proxy" ]; then
        echo "   âœ… ä»£ç†å·²å¼€å¯"
        echo "   HTTP:  ${http_proxy:-æœªè®¾ç½®}"
        echo "   HTTPS: ${https_proxy:-æœªè®¾ç½®}"
        echo "   No Proxy: ${no_proxy:-æœªè®¾ç½®}"
    else
        echo "   âŒ ä»£ç†å·²å…³é—­"
    fi
}

# æµ‹è¯•ä»£ç†è¿æ¥
function proxy_test() {
    if [ -n "$http_proxy" ]; then
        echo "ğŸ” æµ‹è¯•ä»£ç†è¿æ¥..."
        echo "å½“å‰ä»£ç†: ${http_proxy}"
        
        # æµ‹è¯•ä»£ç†æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
        if curl -s --connect-timeout 5 --proxy "${http_proxy}" "http://www.google.com" > /dev/null; then
            echo "âœ… ä»£ç†è¿æ¥æ­£å¸¸"
        else
            echo "âŒ ä»£ç†è¿æ¥å¤±è´¥"
        fi
        
        # æ˜¾ç¤ºå½“å‰ IP
        echo "ğŸŒ å½“å‰å¤–ç½‘ IP:"
        curl -s --connect-timeout 10 --proxy "${http_proxy}" "https://ipinfo.io/ip" || echo "è·å– IP å¤±è´¥"
    else
        echo "âŒ ä»£ç†æœªå¼€å¯ï¼Œè¯·å…ˆè¿è¡Œ proxy_on"
    fi
}

# Git ä»£ç†è®¾ç½®
function git_proxy_on() {
    git config --global http.proxy "${PROXY_URL}"
    git config --global https.proxy "${PROXY_URL}"
    echo "âœ… Git ä»£ç†å·²å¼€å¯: ${PROXY_URL}"
}

function git_proxy_off() {
    git config --global --unset http.proxy
    git config --global --unset https.proxy
    echo "âœ… Git ä»£ç†å·²å…³é—­"
}

function git_proxy_status() {
    echo "ğŸ“¡ Git ä»£ç†çŠ¶æ€ï¼š"
    local git_http_proxy=$(git config --global --get http.proxy)
    local git_https_proxy=$(git config --global --get https.proxy)
    
    if [ -n "$git_http_proxy" ] || [ -n "$git_https_proxy" ]; then
        echo "   âœ… Git ä»£ç†å·²å¼€å¯"
        echo "   HTTP:  ${git_http_proxy:-æœªè®¾ç½®}"
        echo "   HTTPS: ${git_https_proxy:-æœªè®¾ç½®}"
    else
        echo "   âŒ Git ä»£ç†å·²å…³é—­"
    fi
}

# å¿«æ·åˆ«å
alias pon='proxy_on'           # å¼€å¯ä»£ç†
alias poff='proxy_off'         # å…³é—­ä»£ç†
alias pst='proxy_status'       # æŸ¥çœ‹ä»£ç†çŠ¶æ€
alias ptest='proxy_test'       # æµ‹è¯•ä»£ç†
alias gpon='git_proxy_on'      # å¼€å¯ Git ä»£ç†
alias gpoff='git_proxy_off'    # å…³é—­ Git ä»£ç†
alias gpst='git_proxy_status'  # æŸ¥çœ‹ Git ä»£ç†çŠ¶æ€

# è‡ªåŠ¨æ£€æµ‹å¹¶æç¤ºä»£ç†çŠ¶æ€
function check_proxy_on_startup() {
    if [ -n "$http_proxy" ]; then
        echo "ğŸŒ æ£€æµ‹åˆ°ä»£ç†å·²å¼€å¯: ${http_proxy}"
    fi
}

# å¯åŠ¨æ—¶æ£€æŸ¥ä»£ç†çŠ¶æ€
check_proxy_on_startup

# =============================================================================
# åŸºç¡€å¿«æ·å‘½ä»¤ (ä¸ä¸ç°ä»£å·¥å…·å†²çª)
# =============================================================================

# æ–‡ä»¶å’Œç›®å½•æ“ä½œ
# ll, la ç­‰ä¼šè¢«ç°ä»£å·¥å…·é‡æ–°å®šä¹‰ï¼Œè¿™é‡Œæä¾›åå¤‡
if ! command -v exa >/dev/null 2>&1 && ! command -v eza >/dev/null 2>&1; then
    alias ll='ls -alF'
    alias la='ls -A'
    alias l='ls -CF'
fi

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias ~='cd ~'
alias -- -='cd -'

# æ–‡ä»¶æŸ¥çœ‹å’Œç¼–è¾‘ (å¦‚æœæ²¡æœ‰ç°ä»£å·¥å…·)
if ! command -v bat >/dev/null 2>&1; then
    alias cat='cat -n'          # æ˜¾ç¤ºè¡Œå·
fi

if ! command -v rg >/dev/null 2>&1; then
    alias grep='grep --color=auto'
    alias fgrep='fgrep --color=auto'
    alias egrep='egrep --color=auto'
fi

# ç³»ç»Ÿä¿¡æ¯
alias df='df -h'             # äººæ€§åŒ–æ˜¾ç¤ºç£ç›˜ä½¿ç”¨
if ! command -v dust >/dev/null 2>&1; then
    alias du='du -h'         # äººæ€§åŒ–æ˜¾ç¤ºç›®å½•å¤§å°
fi
alias free='free -h'         # äººæ€§åŒ–æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
alias ps='ps auxf'           # è¯¦ç»†è¿›ç¨‹ä¿¡æ¯

# ç½‘ç»œå·¥å…·
alias ping='ping -c 5'       # é»˜è®¤ ping 5 æ¬¡
alias wget='wget -c'         # æ”¯æŒæ–­ç‚¹ç»­ä¼ 

# å®‰å…¨æ“ä½œ
alias rm='rm -i'             # åˆ é™¤å‰ç¡®è®¤

# å¿«é€ŸæŸ¥æ‰¾ (å¦‚æœæ²¡æœ‰ç°ä»£å·¥å…·)
if ! command -v fd >/dev/null 2>&1; then
    alias f='find . -name'   # å¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶
fi
alias h='history | grep'     # åœ¨å†å²è®°å½•ä¸­æœç´¢

# è¿›ç¨‹ç®¡ç†
alias killall='pkill -f'     # æ ¹æ®åç§°æ€æ­»è¿›ç¨‹
alias ports='netstat -tulanp' # æŸ¥çœ‹ç«¯å£å ç”¨

# =============================================================================
# Git ç”¨æˆ·å¿«é€Ÿåˆ‡æ¢
# =============================================================================

# Git ç”¨æˆ·é…ç½®é¢„è®¾
GIT_USER_WORK_NAME="zhaow"
GIT_USER_WORK_EMAIL="zhaow@zhcomputing.com"

GIT_USER_PERSONAL_NAME="zhaowei2025"
GIT_USER_PERSONAL_EMAIL="zhaowei2025@protonmail.com"

# åˆ‡æ¢åˆ°å·¥ä½œè´¦æˆ·
function git_work() {
    git config --global user.name "${GIT_USER_WORK_NAME}"
    git config --global user.email "${GIT_USER_WORK_EMAIL}"
    echo "ğŸ¢ å·²åˆ‡æ¢åˆ°å·¥ä½œ Git è´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_WORK_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_WORK_EMAIL}"
}

# åˆ‡æ¢åˆ°ä¸ªäººè´¦æˆ·
function git_personal() {
    git config --global user.name "${GIT_USER_PERSONAL_NAME}"
    git config --global user.email "${GIT_USER_PERSONAL_EMAIL}"
    echo "ğŸ‘¤ å·²åˆ‡æ¢åˆ°ä¸ªäºº Git è´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_PERSONAL_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_PERSONAL_EMAIL}"
}

# æŸ¥çœ‹å½“å‰ Git ç”¨æˆ·
function git_whoami() {
    local current_name=$(git config --global user.name)
    local current_email=$(git config --global user.email)
    
    echo "ğŸ“‹ å½“å‰ Git ç”¨æˆ·ä¿¡æ¯ï¼š"
    echo "   å§“å: ${current_name:-æœªè®¾ç½®}"
    echo "   é‚®ç®±: ${current_email:-æœªè®¾ç½®}"
    
    # åˆ¤æ–­å½“å‰æ˜¯å“ªä¸ªè´¦æˆ·
    if [[ "$current_name" == "$GIT_USER_WORK_NAME" && "$current_email" == "$GIT_USER_WORK_EMAIL" ]]; then
        echo "   ç±»å‹: ğŸ¢ å·¥ä½œè´¦æˆ·"
    elif [[ "$current_name" == "$GIT_USER_PERSONAL_NAME" && "$current_email" == "$GIT_USER_PERSONAL_EMAIL" ]]; then
        echo "   ç±»å‹: ğŸ‘¤ ä¸ªäººè´¦æˆ·"
    else
        echo "   ç±»å‹: â“ å…¶ä»–è´¦æˆ·"
    fi
}

# ä¸ºå½“å‰ä»“åº“è®¾ç½®ç‰¹å®šçš„ Git ç”¨æˆ·ï¼ˆä¸å½±å“å…¨å±€é…ç½®ï¼‰
function git_local_work() {
    git config user.name "${GIT_USER_WORK_NAME}"
    git config user.email "${GIT_USER_WORK_EMAIL}"
    echo "ğŸ¢ å·²ä¸ºå½“å‰ä»“åº“è®¾ç½®å·¥ä½œè´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_WORK_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_WORK_EMAIL}"
}

function git_local_personal() {
    git config user.name "${GIT_USER_PERSONAL_NAME}"
    git config user.email "${GIT_USER_PERSONAL_EMAIL}"
    echo "ğŸ‘¤ å·²ä¸ºå½“å‰ä»“åº“è®¾ç½®ä¸ªäººè´¦æˆ·ï¼š"
    echo "   å§“å: ${GIT_USER_PERSONAL_NAME}"
    echo "   é‚®ç®±: ${GIT_USER_PERSONAL_EMAIL}"
}

# æŸ¥çœ‹å½“å‰ä»“åº“çš„ Git é…ç½®
function git_local_whoami() {
    if [[ -d .git ]]; then
        local local_name=$(git config user.name)
        local local_email=$(git config user.email)
        local global_name=$(git config --global user.name)
        local global_email=$(git config --global user.email)
        
        echo "ğŸ“‹ å½“å‰ä»“åº“ Git é…ç½®ï¼š"
        echo "   æœ¬åœ°å§“å: ${local_name:-ä½¿ç”¨å…¨å±€é…ç½®}"
        echo "   æœ¬åœ°é‚®ç®±: ${local_email:-ä½¿ç”¨å…¨å±€é…ç½®}"
        echo "   å…¨å±€å§“å: ${global_name:-æœªè®¾ç½®}"
        echo "   å…¨å±€é‚®ç®±: ${global_email:-æœªè®¾ç½®}"
        
        # å®é™…ç”Ÿæ•ˆçš„é…ç½®
        local effective_name="${local_name:-$global_name}"
        local effective_email="${local_email:-$global_email}"
        echo "   ç”Ÿæ•ˆé…ç½®: ${effective_name} <${effective_email}>"
    else
        echo "âŒ å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
    fi
}

# å¿«æ·åˆ«å
alias gwork='git_work'              # åˆ‡æ¢åˆ°å·¥ä½œè´¦æˆ·
alias gpersonal='git_personal'      # åˆ‡æ¢åˆ°ä¸ªäººè´¦æˆ·
alias gwho='git_whoami'             # æŸ¥çœ‹å½“å‰ç”¨æˆ·
alias glwork='git_local_work'       # å½“å‰ä»“åº“ä½¿ç”¨å·¥ä½œè´¦æˆ·
alias glpersonal='git_local_personal' # å½“å‰ä»“åº“ä½¿ç”¨ä¸ªäººè´¦æˆ·
alias glwho='git_local_whoami'      # æŸ¥çœ‹å½“å‰ä»“åº“é…ç½®

# =============================================================================
# Chezmoi GitHub åŒæ­¥å¿«æ·å‘½ä»¤
# =============================================================================

# é…ç½® GitHub token åˆ°è¿œç¨‹ä»“åº“
function setup_git_token() {
    if [[ -n "$GITHUB_TOKEN" ]]; then
        cd ~/.local/share/chezmoi
        git remote set-url origin "https://${GITHUB_TOKEN}@github.com/zhaowei2025/dotfile.git"
        cd -
    fi
}

# åŒæ­¥é…ç½®åˆ° GitHub
function dotfiles_push() {
    echo "ğŸ“¤ åŒæ­¥ dotfiles åˆ° GitHub..."
    
    # ç¡®ä¿ä½¿ç”¨ä¸ªäººè´¦æˆ·
    gpersonal
    
    # è®¾ç½® token è®¤è¯
    setup_git_token
    
    # æ·»åŠ æ‰€æœ‰æ›´æ”¹
    chezmoi git -- add .
    
    # æäº¤æ›´æ”¹
    local commit_msg="${1:-æ›´æ–° dotfiles é…ç½® $(date '+%Y-%m-%d %H:%M:%S')}"
    chezmoi git -- commit -m "$commit_msg"
    
    # æ¨é€åˆ° GitHub
    chezmoi git -- push origin main || chezmoi git -- push --set-upstream origin main
    
    echo "âœ… dotfiles åŒæ­¥å®Œæˆï¼"
}

# ä» GitHub æ‹‰å–é…ç½®
function dotfiles_pull() {
    echo "ğŸ“¥ ä» GitHub æ‹‰å– dotfiles..."
    
    # ç¡®ä¿ä½¿ç”¨ä¸ªäººè´¦æˆ·
    gpersonal
    
    # è®¾ç½® token è®¤è¯
    setup_git_token
    
    # æ‹‰å–æœ€æ–°æ›´æ”¹
    chezmoi git -- pull origin main
    
    # åº”ç”¨æ›´æ”¹
    chezmoi apply
    
    echo "âœ… dotfiles æ‹‰å–å®Œæˆï¼"
}

# æŸ¥çœ‹ dotfiles çŠ¶æ€
function dotfiles_status() {
    echo "ğŸ“Š Dotfiles çŠ¶æ€ï¼š"
    echo ""
    
    # æ˜¾ç¤ºå½“å‰ Git ç”¨æˆ·
    gwho
    echo ""
    
    # æ˜¾ç¤º chezmoi çŠ¶æ€
    echo "ğŸ“‹ Chezmoi çŠ¶æ€ï¼š"
    chezmoi status
    echo ""
    
    # æ˜¾ç¤º Git ä»“åº“çŠ¶æ€
    echo "ğŸ“‹ Git ä»“åº“çŠ¶æ€ï¼š"
    chezmoi cd && git status && cd -
}

# åˆå§‹åŒ–æ–°æœºå™¨çš„ dotfiles
function dotfiles_init() {
    echo "ğŸš€ åˆå§‹åŒ– dotfiles åˆ°æ–°æœºå™¨..."
    
    # å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå…ˆåˆ é™¤
    if [ -d "$HOME/.local/share/chezmoi" ]; then
        echo "âš ï¸  æ£€æµ‹åˆ°å·²å­˜åœ¨çš„ chezmoi é…ç½®ï¼Œæ­£åœ¨å¤‡ä»½..."
        mv "$HOME/.local/share/chezmoi" "$HOME/.local/share/chezmoi.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    # ä½¿ç”¨ token å…‹éš†å¹¶åˆå§‹åŒ–
    if [[ -n "$GITHUB_TOKEN" ]]; then
        chezmoi init "https://${GITHUB_TOKEN}@github.com/zhaowei2025/dotfile.git"
    else
        chezmoi init "https://github.com/zhaowei2025/dotfile.git"
    fi
    
    # åº”ç”¨é…ç½®
    chezmoi apply
    
    echo "âœ… dotfiles åˆå§‹åŒ–å®Œæˆï¼"
}

# ä¸€é”®ç¼–è¾‘å¹¶æ¨é€é…ç½®
function dotfiles_edit() {
    local file="${1:-~/.zshrc}"
    echo "âœï¸  ç¼–è¾‘é…ç½®æ–‡ä»¶: $file"
    chezmoi edit "$file"
    
    echo "ğŸ“¤ è‡ªåŠ¨æäº¤å¹¶æ¨é€æ›´æ”¹..."
    dfpush "ç¼–è¾‘ $file"
}

# å¿«é€Ÿæäº¤å½“å‰æ‰€æœ‰æ›´æ”¹
function dotfiles_quick_save() {
    local msg="${1:-å¿«é€Ÿä¿å­˜ $(date '+%Y-%m-%d %H:%M:%S')}"
    echo "ğŸ’¾ å¿«é€Ÿä¿å­˜æ‰€æœ‰æ›´æ”¹..."
    
    chezmoi git -- add .
    chezmoi git -- commit -m "$msg" && dfpush "$msg"
}

# å¿«æ·åˆ«å
alias dfpush='dotfiles_push'        # æ¨é€é…ç½®
alias dfpull='dotfiles_pull'        # æ‹‰å–é…ç½®
alias dfstatus='dotfiles_status'    # æŸ¥çœ‹çŠ¶æ€
alias dfinit='dotfiles_init'        # åˆå§‹åŒ–æ–°æœºå™¨
alias dfedit='dotfiles_edit'        # ä¸€é”®ç¼–è¾‘å¹¶æ¨é€é…ç½®
alias dfquick='dotfiles_quick_save'  # å¿«é€Ÿæäº¤å½“å‰æ‰€æœ‰æ›´æ”¹

echo "ğŸ‰ ZSH å¢å¼ºé…ç½®å·²åŠ è½½ï¼"
echo ""
echo "ğŸ’¡ ä»£ç†ç®¡ç†å‘½ä»¤ï¼š"
echo "   pon/proxy_on     - å¼€å¯ä»£ç†"
echo "   poff/proxy_off   - å…³é—­ä»£ç†"
echo "   pst/proxy_status - æŸ¥çœ‹ä»£ç†çŠ¶æ€"
echo "   ptest/proxy_test - æµ‹è¯•ä»£ç†è¿æ¥"
echo "   gpon/git_proxy_on    - å¼€å¯ Git ä»£ç†"
echo "   gpoff/git_proxy_off  - å…³é—­ Git ä»£ç†"
echo "   gpst/git_proxy_status - æŸ¥çœ‹ Git ä»£ç†çŠ¶æ€"
echo ""
echo "ğŸ“ ç°ä»£åŒ–å·¥å…·å‘½ä»¤ (å¦‚æœå·²å®‰è£…)ï¼š"
echo "   fd <pattern>     - æ›´å¥½çš„ find"
echo "   rg <pattern>     - æ›´å¥½çš„ grep"
echo "   bat <file>       - æ›´å¥½çš„ cat"
echo "   exa/eza -la      - æ›´å¥½çš„ ls"
echo "   lg               - LazyGit"
echo "   btm              - æ›´å¥½çš„ top"
echo "   dust             - æ›´å¥½çš„ du"
echo ""
echo "ğŸš€ å¢å¼ºåŠŸèƒ½å‘½ä»¤ï¼š"
echo "   mkcd <dir>       - åˆ›å»ºå¹¶è¿›å…¥ç›®å½•"
echo "   extract <file>   - æ™ºèƒ½è§£å‹"
echo "   serve [port]     - å¿«é€ŸHTTPæœåŠ¡å™¨"
echo "   sysinfo          - ç³»ç»Ÿä¿¡æ¯"
echo "   backup <file>    - åˆ›å»ºå¤‡ä»½"
echo "   fvim             - æ¨¡ç³ŠæŸ¥æ‰¾ç¼–è¾‘æ–‡ä»¶"
echo "   fcd              - æ¨¡ç³ŠæŸ¥æ‰¾è¿›å…¥ç›®å½•"
echo ""
echo "ğŸ‘¥ Git ç”¨æˆ·åˆ‡æ¢å‘½ä»¤ï¼š"
echo "   gwork, gpersonal, gwho, glwork, glpersonal, glwho"
echo ""
echo "ğŸ“¦ Dotfiles åŒæ­¥å‘½ä»¤ï¼š"
echo "   dfpush, dfpull, dfstatus, dfinit, dfedit, dfquick"
echo ""
if [[ -f "$ZSH/oh-my-zsh.sh" ]]; then
    echo "âœ… Oh My Zsh å·²åŠ è½½"
else
    echo "âš ï¸  Oh My Zsh æœªå®‰è£…ï¼Œè¿è¡Œå®‰è£…è„šæœ¬æ¥è·å–æ›´å¤šåŠŸèƒ½"
fi

# =============================================================================
# ç¯å¢ƒå˜é‡è®¾ç½®
# =============================================================================

# è®¾ç½®ç»ˆç«¯çœŸå½©è‰²æ”¯æŒ
export COLORTERM=truecolor

# åŠ è½½ç§æœ‰ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆä¸ä¼šè¢« git è¿½è¸ªï¼‰
if [[ -f ~/.env.private ]]; then
    source ~/.env.private
fi

# å¦‚æœå­˜åœ¨é¡¹ç›®ç‰¹å®šçš„ç¯å¢ƒå˜é‡æ–‡ä»¶ä¹ŸåŠ è½½
if [[ -f ./.env.local ]]; then
    source ./.env.local
fi
